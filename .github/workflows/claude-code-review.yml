name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.js"
      # - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Algorithm Analysis
        if: contains(github.event.pull_request.labels.*.name, 'algorithm')
        id: algo-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR_TITLE: ${{ github.event.pull_request.title }}

            [Role]
              You are a specialized Algorithm Problem Solving Reviewer.
              Analyze the provided code and generate structured data for learning logs.

            [Constraints]
              - Respond ONLY with the JSON object inside <data> tags.
              - DO NOT include any greetings, explanations, or conversational text.
              - Ensure the JSON is valid and strictly follows the schema.
              - If the code is invalid or too short, return the JSON with score 0.

            [Evaluation Criteria]
              1. Algorithms and Data Structures used.
              2. Time Complexity (Big-O notation).
              3. Implementation flaws and optimization points.

            [Output Rules]
              - "problem_name": Extract exactly from the PR_TITLE.
              - "category": Extract the primary Data Structure or Category (e.g., Array, String, Stack, Queue, DP, Graph).
              - "used_algorithm": A string array for Multi-select in Notion (e.g., ["DFS", "Sorting"]).
              - "feedback_summary": An array of EXACTLY 3 strings. Each string must be a single concise sentence in Korean.
              - "next_solution_hint": A single sentence in Korean providing guidance for future improvement.
              - "score": An integer between 1 and 10.
              - "created_at": Current date in YYYY-MM-DD format.

            [Output Format]
              - 출력은 반드시 유효한 JSON 단일 객체만 반환한다.
              - 코드블록(````), 태그(<data> 등), 설명, 주석, 추가 텍스트를 절대 포함하지 않는다.
              - 최상위 구조는 하나의 JSON 객체여야 한다.
              - 모든 필드는 아래 JSON 스키마를 정확히 따른다.
              

            {
              "category": "",
              "problem_name": "",
              "used_algorithm": [],
              "time_complexity": "",
              "feedback_summary": [
                "",
                "",
                ""
              ],
              "next_solution_hint": "",
              "score": 1,
              "created_at": ""
            }

      - name: Run Claude Code Review
        if: "!contains(github.event.pull_request.labels.*.name, 'algorithm')"
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Send to Notion
        if: contains(github.event.pull_request.labels.*.name, 'algorithm')
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            [Task]
            이전 Algorithm Analysis 단계에서 생성된 JSON 데이터를 Notion API를 사용하여 데이터베이스에 저장하세요.

            [Environment Variables]
            - NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
            - NOTION_DATABASE_ID: ${{ secrets.NOTION_DB_ID }}
            - EXECUTION_FILE: ${{ steps.algo-review.outputs.execution_file }}

            [Instructions]
            1. 먼저 CLAUDE_OUTPUT 또는 EXECUTION_FILE에서 JSON 데이터를 읽어오세요.
               - EXECUTION_FILE을 읽어서 사용

            2. JSON 데이터는 다음 형식입니다:
               {
                 "category": "자료구조 카테고리",
                 "problem_name": "문제명",
                 "used_algorithm": ["알고리즘1", "알고리즘2"],
                 "time_complexity": "시간 복잡도",
                 "feedback_summary": ["피드백1", "피드백2", "피드백3"],
                 "next_solution_hint": "개선 힌트",
                 "score": 점수,
                 "created_at": "YYYY-MM-DD"
               }

            3. 이 JSON 데이터를 아래 Notion API 형식으로 변환하여 전송하세요:
               POST https://api.notion.com/v1/pages
               Headers:
                 - Authorization: `Bearer ${NOTION_TOKEN}`
                 - Content-Type: `application/json`
                 - Notion-Version: `2022-06-28`

               Body:
               {
                 "parent": { "database_id": "${NOTION_DATABASE_ID}" },
                 "properties": {
                   "문제명": { "title": [{ "text": { "content": "problem_name 값" } }] },
                   "자료구조": { "select": { "name": "category 값" } },
                   "알고리즘": { "multi_select": [{ "name": "알고리즘1" }, { "name": "알고리즘2" }] },
                   "시간복잡도": { "rich_text": [{ "text": { "content": "time_complexity 값" } }] },
                   "점수": { "number": score 값 },
                   "현재 코드 피드백": { "rich_text": [{ "text": { "content": "feedback_summary를 줄바꿈으로 연결한 값" } }] },
                   "향후 개선 사항": { "rich_text": [{ "text": { "content": "next_solution_hint 값" } }] },
                   "분석 날짜": { "date": { "start": "created_at 값" } }
                 }
               }

            4. API 호출이 성공하면 "✅ Notion page created successfully!" 메시지를 출력하세요.
            5. 실패하면 에러 메시지와 함께 실패 사유를 출력하세요.

            [Important]
            - Node.js의 fetch API 또는 Bash의 curl을 사용하여 Notion API를 호출하세요.
            - JSON 파싱 시 다양한 형식(코드블록, wrapper 객체 등)을 처리할 수 있도록 하세요.
