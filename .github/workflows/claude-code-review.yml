name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.js"
      # - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Algorithm Analysis
        if: contains(github.event.pull_request.labels.*.name, 'algorithm')
        id: algo-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR_TITLE: ${{ github.event.pull_request.title }}

            [Role]
              You are a specialized Algorithm Problem Solving Reviewer.
              Analyze the provided code and generate structured data for learning logs.

            [Constraints]
              - Respond ONLY with the JSON object inside <data> tags.
              - DO NOT include any greetings, explanations, or conversational text.
              - Ensure the JSON is valid and strictly follows the schema.
              - If the code is invalid or too short, return the JSON with score 0.

            [Evaluation Criteria]
              1. Algorithms and Data Structures used.
              2. Time Complexity (Big-O notation).
              3. Implementation flaws and optimization points.

            [Output Rules]
              - "problem_name": Extract exactly from the PR_TITLE.
              - "category": Extract the primary Data Structure or Category (e.g., Array, String, Stack, Queue, DP, Graph).
              - "used_algorithm": A string array for Multi-select in Notion (e.g., ["DFS", "Sorting"]).
              - "feedback_summary": An array of EXACTLY 3 strings. Each string must be a single concise sentence in Korean.
              - "next_solution_hint": A single sentence in Korean providing guidance for future improvement.
              - "score": An integer between 1 and 10.
              - "created_at": Current date in YYYY-MM-DD format.

            [Output Format]
              - 출력은 반드시 유효한 JSON 단일 객체만 반환한다.
              - 코드블록(````), 태그(<data> 등), 설명, 주석, 추가 텍스트를 절대 포함하지 않는다.
              - 최상위 구조는 하나의 JSON 객체여야 한다.
              - 모든 필드는 아래 JSON 스키마를 정확히 따른다.
              

            {
              "category": "",
              "problem_name": "",
              "used_algorithm": [],
              "time_complexity": "",
              "feedback_summary": [
                "",
                "",
                ""
              ],
              "next_solution_hint": "",
              "score": 1,
              "created_at": ""
            }

      - name: Debug JSON Output
        if: contains(github.event.pull_request.labels.*.name, 'algorithm')
        run: |
          echo "Generated JSON:"
          echo '${{ steps.algo-review.outputs.structured_output }}'

      - name: Run Claude Code Review
        if: "!contains(github.event.pull_request.labels.*.name, 'algorithm')"
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or issues
            - Performance considerations
            - Security concerns
            - Test coverage

            Use the repository's CLAUDE.md for guidance on style and conventions. Be constructive and helpful in your feedback.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

      - name: Send to Notion
        if: contains(github.event.pull_request.labels.*.name, 'algorithm')
        run: |
          node << 'EOF'
          const https = require('https');

          const jsonData = JSON.parse(process.env.JSON_DATA);

          const notionData = {
            parent: { database_id: process.env.NOTION_DB_ID },
            properties: {
              "문제명": {
                title: [{ text: { content: jsonData.problem_name } }]
              },
              "카테고리": {
                select: { name: jsonData.category }
              },
              "알고리즘": {
                multi_select: jsonData.used_algorithm.map(algo => ({ name: algo }))
              },
              "시간복잡도": {
                rich_text: [{ text: { content: jsonData.time_complexity } }]
              },
              "점수": {
                number: jsonData.score
              },
              "날짜": {
                date: { start: jsonData.created_at }
              },
              "피드백": {
                rich_text: [{ text: { content: jsonData.feedback_summary.join('\n') } }]
              },
              "개선힌트": {
                rich_text: [{ text: { content: jsonData.next_solution_hint } }]
              }
            }
          };

          const data = JSON.stringify(notionData);

          const options = {
            hostname: 'api.notion.com',
            path: '/v1/pages',
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${process.env.NOTION_TOKEN}`,
              'Content-Type': 'application/json',
              'Notion-Version': '2022-06-28',
              'Content-Length': data.length
            }
          };

          const req = https.request(options, (res) => {
            let responseData = '';
            res.on('data', (chunk) => { responseData += chunk; });
            res.on('end', () => {
              console.log('Status:', res.statusCode);
              console.log('Response:', responseData);
            });
          });

          req.on('error', (error) => {
            console.error('Error:', error);
            process.exit(1);
          });

          req.write(data);
          req.end();
          EOF
        env:
          JSON_DATA: ${{ steps.algo-review.outputs.structured_output }}
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
